<!DOCTYPE html>
<html lang="ur">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live + JSON + Upload | Universal TeleHealth Dashboard</title>

<style>
    body { font-family: Arial; background: #eef1f7; padding: 20px; }
    .container { background: white; padding: 20px; border-radius: 10px; max-width: 1300px; margin: auto; }
    .header { text-align:center; background:#1e3c72; color:white; padding:20px; border-radius:10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th { background: #2c3e50; color:white; padding:10px; }
    td { border: 1px solid #ccc; padding: 8px; }
    input[type="number"] { width: 90%; }
    .status { display:none; padding:10px; margin-top:15px; border-radius:6px; color:white; font-weight:bold; }
    .btn { padding:10px 18px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; margin-right:10px; }
    .btn-primary { background:#1976D2; color:white; }
    .btn-success { background:#43A047; color:white; }
    .btn-warning { background:#FB8C00; color:white; }
    .btn-info { background:#6A1B9A; color:white; }
</style>
</head>

<body>

<div class="container">

    <div class="header">
        <h2>ðŸ“Š Universal TeleHealth Progress Dashboard</h2>
        <p id="currentDate"></p>
    </div>

    <br>

    <button class="btn btn-success" onclick="loadFromAPI()">ðŸ”„ Load From API</button>
    <button class="btn btn-primary" onclick="saveToAPI()">ðŸ’¾ Save Changes (API)</button>
    <button class="btn btn-warning" onclick="uploadJSONtoAPI()">â¬† Upload JSON â†’ API</button>

    <label class="btn btn-info">
        ðŸ“¥ Import JSON
        <input type="file" id="jsonFile" accept="application/json" style="display:none" onchange="loadLocalJSON(event)">
    </label>

    <div id="apiStatus" class="status"></div>

    <table>
        <thead>
            <tr>
                <th>Sr.No</th>
                <th>Branch</th>
                <th>Staff Name</th>
                <th>Designation</th>
                <th>Re-subscriber</th>
                <th>New Onboarding</th>
                <th>Total</th>
                <th>Opening</th>
                <th>Received</th>
                <th>Deposit</th>
                <th>Closing</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

</div>

<script>

// -------------------------------
// USER INPUT API SETTINGS
// -------------------------------
const API_URL = prompt("Enter your SheetBest API URL:", "");
const API_KEY = prompt("Enter your API KEY:", "");

// -------------------------------
// JSON FALLBACK DATA (OPTION-C)
// -------------------------------
let fallbackJSON = {
  "data": [
    { "Sr.No": 1, "Branch": "Test Branch", "Staff Name": "Ali", "Designation": "Manager",
      "Re-subscriber": 5, "New Onboarding": 3, "Opening Balance": 200,
      "Today Received": 50, "Today Deposit": 60 }
  ]
};

let tableData = [];
let modifiedRows = new Set();

// -------------------------------
// LOAD DATE
// -------------------------------
document.getElementById("currentDate").innerText =
    new Date().toLocaleDateString("en-GB");

// -------------------------------
// LOAD FROM API (OPTION-1)
// -------------------------------
async function loadFromAPI() {
    showStatus("â³ Loading from API...", "blue");

    try {
        const res = await fetch(API_URL, {
            headers: { "Authorization": `Bearer ${API_KEY}` }
        });
        const data = await res.json();
        tableData = data;
        renderTable();
        showStatus("âœ… Loaded from API", "green");

    } catch (e) {
        showStatus("âš  API unavailable â†’ Loading fallback JSON", "orange");
        tableData = fallbackJSON.data;
        renderTable();
    }
}

// -------------------------------
// SAVE INDIVIDUAL CHANGED ROWS
// -------------------------------
async function saveToAPI() {
    if (modifiedRows.size === 0)
        return showStatus("âš  No changes to save!", "orange");

    showStatus("â³ Saving to API...", "blue");

    for (let index of modifiedRows) {
        let row = tableData[index];

        await fetch(`${API_URL}/Sr.No/${row["Sr.No"]}`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${API_KEY}`
            },
            body: JSON.stringify({ data: row })
        });
    }

    modifiedRows.clear();
    showStatus("âœ… Saved successfully!", "green");
}

// -------------------------------
// UPLOAD WHOLE JSON â†’ API
// -------------------------------
async function uploadJSONtoAPI() {
    showStatus("â³ Uploading full JSON...", "blue");

    await fetch(API_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_KEY}`
        },
        body: JSON.stringify(tableData)
    });

    showStatus("âœ… JSON uploaded to API!", "green");
}

// -------------------------------
// IMPORT LOCAL JSON FILE
// -------------------------------
function loadLocalJSON(event) {
    let file = event.target.files[0];
    let reader = new FileReader();

    reader.onload = function(e) {
        tableData = JSON.parse(e.target.result);
        if (tableData.data) tableData = tableData.data;
        renderTable();
        showStatus("ðŸ“¥ JSON Loaded!", "green");
    };

    reader.readAsText(file);
}

// -------------------------------
// RENDER TABLE
// -------------------------------
function renderTable() {
    let tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    tableData.forEach((row, i) => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${row["Sr.No"] || i+1}</td>
            <td>${row["Branch"]}</td>
            <td>${row["Staff Name"]}</td>
            <td>${row["Designation"]}</td>

            <td><input type="number" value="${row["Re-subscriber"]}" onchange="update(${i}, 'Re-subscriber', this.value)"></td>

            <td><input type="number" value="${row["New Onboarding"]}" onchange="update(${i}, 'New Onboarding', this.value)"></td>

            <td>${(+row["Re-subscriber"]) + (+row["New Onboarding"])}</td>

            <td><input type="number" value="${row["Opening Balance"]}" onchange="update(${i}, 'Opening Balance', this.value)"></td>

            <td><input type="number" value="${row["Today Received"]}" onchange="update(${i}, 'Today Received', this.value)"></td>

            <td><input type="number" value="${row["Today Deposit"]}" onchange="update(${i}, 'Today Deposit', this.value)"></td>

            <td>${(+row["Opening Balance"]) + (+row["Today Received"]) - (+row["Today Deposit"])}</td>
        `;
        tbody.appendChild(tr);
    });
}

// -------------------------------
// UPDATE FIELD
// -------------------------------
function update(i, field, value) {
    tableData[i][field] = value;
    modifiedRows.add(i);
}

// -------------------------------
function showStatus(msg, color) {
    let box = document.getElementById("apiStatus");
    box.style.display = "block";
    box.style.background = color;
    box.innerText = msg;
}

// Auto-load
loadFromAPI();

</script>
</body>
</html>
