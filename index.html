<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sehat Kahani - Tele Health Progress Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .date-display {
            font-size: 18px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #0b7dda;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .btn-success {
            background: #0F9D58;
            color: white;
        }

        .btn-success:hover {
            background: #0d8a4d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 157, 88, 0.4);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #e68900;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }

        .btn-info {
            background: #9C27B0;
            color: white;
        }

        .btn-info:hover {
            background: #7B1FA2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.4);
        }

        #reportContent {
            padding: 30px;
            background: white;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        td {
            padding: 12px 10px;
            border: 1px solid #e0e0e0;
            font-size: 14px;
            vertical-align: middle;
        }

        tr:hover {
            background: #f5f5f5;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .editable {
            background: #fff3cd;
        }

        .calculated {
            background: #d4edda;
            font-weight: 600;
            color: #155724;
        }

        .summary {
            padding: 20px 30px;
            background: #e3f2fd;
            border-top: 2px solid #2196F3;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary-item h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .summary-item .value {
            font-size: 28px;
            font-weight: bold;
            color: #2196F3;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        #toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #323232;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            display: none;
            animation: slideUp 0.3s;
            z-index: 2000;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }

        select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .no-export {
            /* Column that won't be exported */
        }

        @media print {
            .controls, .no-export {
                display: none !important;
            }
        }

        /* Google Sheets Status */
        .sheets-status {
            padding: 10px 20px;
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        .sheets-status.error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .sheets-status.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Sehat Kahani - Tele Health Progress Report</h1>
            <div class="date-display" id="currentDate"></div>
        </div>

        <div class="controls">
            <button class="btn btn-success" onclick="loadFromGoogleSheets()">
                üìä Load from Google Sheets
            </button>
            <button class="btn btn-success" onclick="saveToGoogleSheets()">
                üíæ Save to Google Sheets
            </button>
            <button class="btn btn-primary" onclick="saveData()">
                üíæ Save Locally
            </button>
            <button class="btn btn-secondary" onclick="exportToExcel()">
                üì• Export Excel
            </button>
            <button class="btn btn-secondary" onclick="exportToCSV()">
                üìÑ Export CSV
            </button>
            <button class="btn btn-warning" onclick="downloadAsImage('png')">
                üñºÔ∏è PNG
            </button>
            <button class="btn btn-warning" onclick="downloadAsImage('jpg')">
                üì∑ JPG
            </button>
            <button class="btn btn-info" onclick="openAddRowModal()">
                ‚ûï Add Employee
            </button>
            <button class="btn btn-info" onclick="openGoogleDriveModal()">
                ‚öôÔ∏è Configure Google Sheet
            </button>
            <select id="branchFilter" onchange="filterByBranch()">
                <option value="all">All Branches</option>
            </select>
            <button class="btn btn-danger" onclick="resetData()">
                üîÑ Reset
            </button>
        </div>

        <div id="sheetsStatus" class="sheets-status" style="display:none;"></div>

        <div id="reportContent">
            <div class="loading" id="loadingIndicator">
                ‚è≥ Loading data...
            </div>
            
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Sr.No</th>
                            <th>Branch</th>
                            <th>Staff Name</th>
                            <th>Designation</th>
                            <th>Re-subscriber</th>
                            <th>New Onboarding</th>
                            <th>Grand Total</th>
                            <th>Opening Balance</th>
                            <th>Today Received</th>
                            <th>Today Deposit</th>
                            <th>Closing Balance</th>
                            <th class="no-export">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="summary">
            <div class="summary-item">
                <h3>Total Employees</h3>
                <div class="value" id="totalEmployees">0</div>
            </div>
            <div class="summary-item">
                <h3>Total Re-subscribers</h3>
                <div class="value" id="totalReSubscribers">0</div>
            </div>
            <div class="summary-item">
                <h3>Total New Onboarding</h3>
                <div class="value" id="totalNewOnboarding">0</div>
            </div>
            <div class="summary-item">
                <h3>Grand Total</h3>
                <div class="value" id="grandTotal">0</div>
            </div>
            <div class="summary-item">
                <h3>Total Cash Received</h3>
                <div class="value" id="totalReceived">0</div>
            </div>
            <div class="summary-item">
                <h3>Total Deposit</h3>
                <div class="value" id="totalDeposit">0</div>
            </div>
        </div>
    </div>

    <!-- Add Row Modal -->
    <div id="addRowModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addRowModal')">&times;</span>
            <h2>‚ûï Add New Employee</h2>
            <form id="addRowForm">
                <div class="form-group">
                    <label>Branch:</label>
                    <input type="text" id="newBranch" required>
                </div>
                <div class="form-group">
                    <label>Staff Name:</label>
                    <input type="text" id="newStaffName" required>
                </div>
                <div class="form-group">
                    <label>Designation:</label>
                    <input type="text" id="newDesignation" required>
                </div>
                <button type="submit" class="btn btn-success">Add Employee</button>
            </form>
        </div>
    </div>

    <!-- Google Drive Configuration Modal -->
    <div id="googleDriveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('googleDriveModal')">&times;</span>
            <h2>‚öôÔ∏è Configure Google Sheets</h2>
            <div class="form-group">
                <label>Google Sheet ID:</label>
                <input type="text" id="googleSheetId" value="1lzZT5wK014u2CTZlEMIiE9UUa3NE-mXR" placeholder="Enter Google Sheet ID">
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    Copy the ID from your Google Sheets URL:<br>
                    <code>https://docs.google.com/spreadsheets/d/<strong>[THIS_IS_THE_ID]</strong>/edit</code>
                </p>
            </div>
            <button class="btn btn-success" onclick="updateGoogleSheetId()">Save Configuration</button>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        // =====================================================
        // CONFIGURATION
        // =====================================================
        
        const CONFIG = {
            GOOGLE_SHEET_ID: localStorage.getItem('googleSheetId') || '1lzZT5wK014u2CTZlEMIiE9UUa3NE-mXR',
            SHEET_NAME: 'Sheet1' // Default sheet name
        };

        // =====================================================
        // DATA FROM EXCEL FILE
        // =====================================================
        
        const INITIAL_DATA = [
            {"srNo": 1, "branch": "Mianwali-1", "staffName": "Muhammad Sijad", "designation": "Assistant Branch Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 2, "branch": "Mianwali-1", "staffName": "Zafar Iqbal", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 3, "branch": "Mianwali-1", "staffName": "Karam Elahi", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 4, "branch": "Mianwali-1", "staffName": "Shahid Abbas", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 5, "branch": "Mianwali-1", "staffName": "Nadeem Abbas", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 6, "branch": "Mianwali-1", "staffName": "Arslan Haider", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 7, "branch": "Mianwali-2", "staffName": "Javed Iqbal", "designation": "Assistant Branch Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 8, "branch": "Mianwali-2", "staffName": "Ashfaq Hussain", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 9, "branch": "Mianwali-2", "staffName": "Naveed Anwar", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 10, "branch": "Mianwali-2", "staffName": "Muhammad Arshad", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 11, "branch": "Mianwali-2", "staffName": "Atif Ahmed", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 12, "branch": "Mianwali-2", "staffName": "Jawad Chohan", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 13, "branch": "Piplan", "staffName": "Muhammad Faryad", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 14, "branch": "Piplan", "staffName": "Umair Khizar", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 15, "branch": "Piplan", "staffName": "Kashif Masood", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 16, "branch": "Piplan", "staffName": "Ali Raza", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 17, "branch": "Piplan", "staffName": "Muhammad Akram", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 18, "branch": "Piplan", "staffName": "Muhammad Sabih", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 19, "branch": "Essa Khail", "staffName": "Imran Elahi", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 20, "branch": "Essa Khail", "staffName": "Asad Latif", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 21, "branch": "Essa Khail", "staffName": "Yaqoob Shahzad", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 22, "branch": "Essa Khail", "staffName": "Waqas Shahzad", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 23, "branch": "Essa Khail", "staffName": "Shamraiz Hassan", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 24, "branch": "Essa Khail", "staffName": "Shahbaz Aslam", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0},
            {"srNo": 25, "branch": "Essa Khail", "staffName": "Muhammad Tahir", "designation": "Unit Manager", "reSubscriber": 0, "newOnboarding": 0, "openingBalance": 0, "todayReceived": 0, "todayDeposit": 0}
        ];

        let tableData = [];

        // =====================================================
        // INITIALIZATION
        // =====================================================

        function init() {
            // Display current date
            const today = new Date();
            document.getElementById('currentDate').textContent = 
                today.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

            // Load data
            const savedData = localStorage.getItem('telehealthData');
            if (savedData) {
                tableData = JSON.parse(savedData);
            } else {
                tableData = [...INITIAL_DATA];
            }

            renderTable();
            updateSummary();
            populateBranchFilter();

            // Load saved Google Sheet ID
            const savedSheetId = localStorage.getItem('googleSheetId');
            if (savedSheetId) {
                document.getElementById('googleSheetId').value = savedSheetId;
            }
        }

        // =====================================================
        // GOOGLE SHEETS INTEGRATION
        // =====================================================

        function updateGoogleSheetId() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            if (sheetId) {
                CONFIG.GOOGLE_SHEET_ID = sheetId;
                localStorage.setItem('googleSheetId', sheetId);
                showToast('‚úÖ Google Sheet ID updated!');
                closeModal('googleDriveModal');
            } else {
                showToast('‚ùå Please enter a valid Sheet ID');
            }
        }

        async function loadFromGoogleSheets() {
            showSheetsStatus('Loading from Google Sheets...', 'warning');
            
            try {
                // Construct the CSV export URL
                const csvUrl = `https://docs.google.com/spreadsheets/d/${CONFIG.GOOGLE_SHEET_ID}/export?format=csv&gid=0`;
                
                showToast('üì• Fetching data from Google Sheets...');
                
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch Google Sheets. Make sure the sheet is shared as "Anyone with the link can view"');
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows.length < 3) {
                    throw new Error('Sheet appears to be empty or has invalid format');
                }
                
                // Parse the data (skip header rows)
                const newData = [];
                for (let i = 2; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row[0] || row[0] === 'Total' || row[0] === '') continue;
                    
                    try {
                        const record = {
                            srNo: parseInt(row[0]) || i - 1,
                            branch: row[1] || '',
                            staffName: row[2] || '',
                            designation: row[3] || '',
                            reSubscriber: parseInt(row[4]) || 0,
                            newOnboarding: parseInt(row[5]) || 0,
                            openingBalance: parseInt(row[7]) || 0,
                            todayReceived: parseInt(row[8]) || 0,
                            todayDeposit: parseInt(row[9]) || 0
                        };
                        newData.push(record);
                    } catch (e) {
                        console.warn('Skipping row', i, ':', e);
                    }
                }
                
                if (newData.length === 0) {
                    throw new Error('No valid data found in the sheet');
                }
                
                tableData = newData;
                renderTable();
                updateSummary();
                populateBranchFilter();
                saveData();
                
                showSheetsStatus(`‚úÖ Successfully loaded ${newData.length} records from Google Sheets`, 'success');
                showToast(`‚úÖ Loaded ${newData.length} records from Google Sheets!`);
                
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                showSheetsStatus('‚ùå Error: ' + error.message, 'error');
                showToast('‚ùå Error: ' + error.message);
            }
        }

        async function saveToGoogleSheets() {
            showSheetsStatus('Saving to Google Sheets requires Google Apps Script...', 'warning');
            showToast('‚ö†Ô∏è Direct save requires Google Apps Script setup');
            
            // Show instructions
            const instructions = `
To enable saving to Google Sheets:

1. Open your Google Sheet: 
   https://docs.google.com/spreadsheets/d/${CONFIG.GOOGLE_SHEET_ID}/edit

2. Go to Extensions ‚Üí Apps Script

3. Replace all code with the following:

function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  
  // Clear existing data (keep headers)
  var lastRow = sheet.getLastRow();
  if (lastRow > 2) {
    sheet.getRange(3, 1, lastRow - 2, 11).clearContent();
  }
  
  // Write new data
  data.forEach(function(row, index) {
    sheet.getRange(index + 3, 1, 1, 11).setValues([[
      row.srNo, row.branch, row.staffName, row.designation,
      row.reSubscriber, row.newOnboarding, 
      row.reSubscriber + row.newOnboarding,
      row.openingBalance, row.todayReceived, row.todayDeposit,
      row.openingBalance + row.todayReceived - row.todayDeposit
    ]]);
  });
  
  return ContentService.createTextOutput(JSON.stringify({success: true}))
    .setMimeType(ContentService.MimeType.JSON);
}

4. Click "Deploy" ‚Üí "New deployment"
5. Select "Web app"
6. Set "Execute as: Me"
7. Set "Who has access: Anyone"
8. Click "Deploy" and copy the Web App URL
9. Update CONFIG.APPS_SCRIPT_URL with your URL

For now, use "Export Excel" to save your changes!
            `;
            
            alert(instructions);
        }

        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentCell || currentRow.length > 0) {
                        currentRow.push(currentCell.trim());
                        rows.push(currentRow);
                        currentRow = [];
                        currentCell = '';
                    }
                    if (char === '\r' && nextChar === '\n') {
                        i++;
                    }
                } else {
                    currentCell += char;
                }
            }
            
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                rows.push(currentRow);
            }
            
            return rows;
        }

        function showSheetsStatus(message, type = 'success') {
            const statusDiv = document.getElementById('sheetsStatus');
            statusDiv.textContent = message;
            statusDiv.className = `sheets-status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // =====================================================
        // TABLE RENDERING
        // =====================================================

        function renderTable(filterBranch = 'all') {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const filteredData = filterBranch === 'all' 
                ? tableData 
                : tableData.filter(row => row.branch === filterBranch);

            filteredData.forEach((row, index) => {
                const actualIndex = tableData.indexOf(row);
                const grandTotal = row.reSubscriber + row.newOnboarding;
                const closingBalance = row.openingBalance + row.todayReceived - row.todayDeposit;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.srNo}</td>
                    <td>${row.branch}</td>
                    <td>${row.staffName}</td>
                    <td>${row.designation}</td>
                    <td class="editable">
                        <input type="number" value="${row.reSubscriber}" 
                               onchange="updateValue(${actualIndex}, 'reSubscriber', this.value)" 
                               min="0">
                    </td>
                    <td class="editable">
                        <input type="number" value="${row.newOnboarding}" 
                               onchange="updateValue(${actualIndex}, 'newOnboarding', this.value)" 
                               min="0">
                    </td>
                    <td class="calculated">${grandTotal}</td>
                    <td class="editable">
                        <input type="number" value="${row.openingBalance}" 
                               onchange="updateValue(${actualIndex}, 'openingBalance', this.value)" 
                               min="0">
                    </td>
                    <td class="editable">
                        <input type="number" value="${row.todayReceived}" 
                               onchange="updateValue(${actualIndex}, 'todayReceived', this.value)" 
                               min="0">
                    </td>
                    <td class="editable">
                        <input type="number" value="${row.todayDeposit}" 
                               onchange="updateValue(${actualIndex}, 'todayDeposit', this.value)" 
                               min="0">
                    </td>
                    <td class="calculated">${closingBalance}</td>
                    <td class="no-export">
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" 
                                onclick="deleteRow(${actualIndex})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateValue(index, field, value) {
            tableData[index][field] = parseInt(value) || 0;
            updateSummary();
        }

        function updateSummary() {
            const totals = {
                employees: tableData.length,
                reSubscribers: tableData.reduce((sum, row) => sum + row.reSubscriber, 0),
                newOnboarding: tableData.reduce((sum, row) => sum + row.newOnboarding, 0),
                received: tableData.reduce((sum, row) => sum + row.todayReceived, 0),
                deposit: tableData.reduce((sum, row) => sum + row.todayDeposit, 0)
            };

            document.getElementById('totalEmployees').textContent = totals.employees;
            document.getElementById('totalReSubscribers').textContent = totals.reSubscribers;
            document.getElementById('totalNewOnboarding').textContent = totals.newOnboarding;
            document.getElementById('grandTotal').textContent = totals.reSubscribers + totals.newOnboarding;
            document.getElementById('totalReceived').textContent = totals.received;
            document.getElementById('totalDeposit').textContent = totals.deposit;
        }

        // =====================================================
        // DATA MANAGEMENT
        // =====================================================

        function saveData() {
            localStorage.setItem('telehealthData', JSON.stringify(tableData));
            showToast('üíæ Data saved locally!');
        }

        function resetData() {
            if (confirm('Reset all data to original values? This cannot be undone.')) {
                localStorage.removeItem('telehealthData');
                location.reload();
            }
        }

        // =====================================================
        // EXPORT FUNCTIONS
        // =====================================================

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Branch Wise Sehat Kahani Progress Report - Mianwali Area'],
                ['Date: ' + new Date().toLocaleDateString('en-GB')],
                [],
                ['Sr.No', 'Branch', 'Staff Name', 'Designation', 'Re-subscriber', 'New Onboarding', 'Grand Total', 'Opening Balance', 'Today Received', 'Today Deposit', 'Closing Balance']
            ];

            tableData.forEach(row => {
                wsData.push([
                    row.srNo, row.branch, row.staffName, row.designation,
                    row.reSubscriber, row.newOnboarding, 
                    row.reSubscriber + row.newOnboarding,
                    row.openingBalance, row.todayReceived, row.todayDeposit,
                    row.openingBalance + row.todayReceived - row.todayDeposit
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Set column widths
            ws['!cols'] = [
                {wch: 8}, {wch: 15}, {wch: 25}, {wch: 25}, 
                {wch: 15}, {wch: 15}, {wch: 12}, {wch: 18}, 
                {wch: 18}, {wch: 18}, {wch: 18}
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Report');
            XLSX.writeFile(wb, `Telehealth_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('üìä Excel exported!');
        }

        function exportToCSV() {
            let csv = 'Sr.No,Branch,Staff Name,Designation,Re-subscriber,New Onboarding,Grand Total,Opening Balance,Today Received,Today Deposit,Closing Balance\n';
            tableData.forEach(row => {
                const gt = row.reSubscriber + row.newOnboarding;
                const cb = row.openingBalance + row.todayReceived - row.todayDeposit;
                csv += `${row.srNo},"${row.branch}","${row.staffName}","${row.designation}",${row.reSubscriber},${row.newOnboarding},${gt},${row.openingBalance},${row.todayReceived},${row.todayDeposit},${cb}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Telehealth_Report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('üìÑ CSV exported!');
        }

        async function downloadAsImage(format = 'png') {
            showToast('üì∏ Generating high-quality image...');
            
            const controls = document.querySelector('.controls');
            const actionCells = document.querySelectorAll('.no-export');
            const sheetsStatus = document.getElementById('sheetsStatus');
            const originalDisplay = controls.style.display;
            const originalStatusDisplay = sheetsStatus.style.display;
            
            controls.style.display = 'none';
            sheetsStatus.style.display = 'none';
            actionCells.forEach(cell => cell.style.display = 'none');
            
            try {
                const reportContent = document.getElementById('reportContent');
                
                if (!window.html2canvas) {
                    await loadHtml2Canvas();
                }
                
                // Higher scale and quality settings
                const canvas = await html2canvas(reportContent, {
                    backgroundColor: '#ffffff',
                    scale: 3, // Higher quality - 3x resolution
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    windowWidth: 1400,
                    width: reportContent.scrollWidth,
                    height: reportContent.scrollHeight,
                    onclone: function(clonedDoc) {
                        // Make sure all text is visible in clone
                        const clonedTable = clonedDoc.querySelector('table');
                        if (clonedTable) {
                            clonedTable.style.tableLayout = 'fixed';
                            const cells = clonedDoc.querySelectorAll('td, th');
                            cells.forEach(cell => {
                                cell.style.wordWrap = 'break-word';
                                cell.style.whiteSpace = 'normal';
                            });
                        }
                    }
                });
                
                const imageType = format === 'jpg' ? 'image/jpeg' : 'image/png';
                const quality = format === 'jpg' ? 0.98 : 1.0; // Higher quality for JPG
                
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `Telehealth_Report_${new Date().toISOString().split('T')[0]}.${format}`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    showToast(`‚úÖ High-quality ${format.toUpperCase()} downloaded!`);
                }, imageType, quality);
                
            } catch (error) {
                console.error('Error generating image:', error);
                showToast('‚ùå Error generating image: ' + error.message);
            } finally {
                controls.style.display = originalDisplay;
                sheetsStatus.style.display = originalStatusDisplay;
                actionCells.forEach(cell => cell.style.display = '');
            }
        }

        function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // =====================================================
        // ADD/DELETE ROWS
        // =====================================================

        function openAddRowModal() {
            document.getElementById('addRowModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openGoogleDriveModal() {
            document.getElementById('googleDriveModal').style.display = 'block';
        }

        document.getElementById('addRowForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newRow = {
                srNo: tableData.length + 1,
                branch: document.getElementById('newBranch').value,
                staffName: document.getElementById('newStaffName').value,
                designation: document.getElementById('newDesignation').value,
                reSubscriber: 0, 
                newOnboarding: 0,
                openingBalance: 0, 
                todayReceived: 0, 
                todayDeposit: 0
            };
            tableData.push(newRow);
            renderTable();
            updateSummary();
            populateBranchFilter();
            saveData();
            closeModal('addRowModal');
            this.reset();
            showToast('‚úÖ Employee added!');
        });

        function deleteRow(index) {
            if (confirm('Delete this employee record?')) {
                tableData.splice(index, 1);
                tableData.forEach((row, i) => row.srNo = i + 1);
                renderTable(document.getElementById('branchFilter').value);
                updateSummary();
                populateBranchFilter();
                saveData();
                showToast('üóëÔ∏è Employee deleted!');
            }
        }

        // =====================================================
        // FILTERING
        // =====================================================

        function populateBranchFilter() {
            const branches = [...new Set(tableData.map(row => row.branch))];
            const select = document.getElementById('branchFilter');
            const currentValue = select.value;
            select.innerHTML = '<option value="all">All Branches</option>';
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                select.appendChild(option);
            });
            select.value = currentValue;
        }

        function filterByBranch() {
            renderTable(document.getElementById('branchFilter').value);
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Initialize on page load
        init();
    </script>

    <!-- Required Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
