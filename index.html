<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sehat Kahani - Tele Health Progress Report (SheetBest API Connected)</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef1f7;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 20px;
            max-width: 1300px;
            margin: auto;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .header {
            text-align: center;
            padding: 20px;
            background: #1e3c72;
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th {
            background: #2c3e50;
            color: white;
            padding: 10px;
            position: sticky;
            top: 0;
        }
        td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        input[type="number"] {
            width: 90%;
            padding: 4px;
        }
        .status {
            padding: 10px;
            margin-top: 10px;
            display: none;
            border-radius: 6px;
            font-weight: bold;
        }
        .btn {
            padding: 10px 18px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 6px;
            margin-right: 10px;
        }
        .btn-primary { background: #1e88e5; color: white; }
        .btn-success { background: #43a047; color: white; }
        .btn-warning { background: #fb8c00; color: white; }
    </style>
</head>

<body>

<div class="container">

    <div class="header">
        <h1>üè• Sehat Kahani - Tele Health Progress Report</h1>
        <p id="currentDate"></p>
    </div>

    <button class="btn btn-success" onclick="loadFromAPI()">üîÑ Refresh</button>
    <button class="btn btn-primary" onclick="saveToAPI()">üíæ Save Changes</button>

    <div class="status" id="apiStatus"></div>

    <table>
        <thead>
        <tr>
            <th>Sr.No</th>
            <th>Branch</th>
            <th>Staff Name</th>
            <th>Designation</th>
            <th>Re-subscriber</th>
            <th>New Onboarding</th>
            <th>Grand Total</th>
            <th>Opening Balance</th>
            <th>Today Received</th>
            <th>Today Deposit</th>
            <th>Closing Balance</th>
        </tr>
        </thead>

        <tbody id="tableBody"></tbody>
    </table>

</div>

<script>

// ----------------------------
// YOUR SHEETBEST API SETTINGS
// ----------------------------
const API_URL = "https://api.sheetbest.com/sheets/8c42dff2-d012-4a55-9b1a-41770fab3ea7";

const API_KEY = "R4JrR0lvUVVeuPWCpY7f9XNKbOInA4h1%_qOdHjpzAimDUi5QI8iZ3mz35S9B08g";

let tableData = [];
let modifiedRows = new Set();

// ----------------------------
// Load current date
// ----------------------------
document.getElementById("currentDate").innerText =
    new Date().toLocaleDateString("en-GB");

// ----------------------------
// LOAD DATA FROM SHEETBEST
// ----------------------------
async function loadFromAPI() {
    showStatus("‚è≥ Loading data...", "blue");

    try {
        const res = await fetch(API_URL, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${API_KEY}`
            }
        });

        const data = await res.json();
        tableData = data;
        renderTable();

        showStatus("‚úÖ Data loaded successfully!", "green");

    } catch (err) {
        showStatus("‚ùå Error loading data: " + err.message, "red");
    }
}

// ----------------------------
// SAVE CHANGES TO SHEETBEST
// ----------------------------
async function saveToAPI() {
    if (modifiedRows.size === 0) {
        showStatus("‚ö†Ô∏è No changes to save!", "orange");
        return;
    }

    showStatus("‚è≥ Saving changes...", "blue");

    for (let index of modifiedRows) {
        let row = tableData[index];

        await fetch(`${API_URL}/Sr.No/${row["Sr.No"]}`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${API_KEY}`
            },
            body: JSON.stringify({ data: row })
        });
    }

    modifiedRows.clear();
    showStatus("‚úÖ All changes saved!", "green");
}

// ----------------------------
// RENDER TABLE
// ----------------------------
function renderTable() {
    let tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    tableData.forEach((row, i) => {
        let tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${row["Sr.No"]}</td>
            <td>${row["Branch"]}</td>
            <td>${row["Staff Name"]}</td>
            <td>${row["Designation"]}</td>

            <td><input type="number" value="${row["Re-subscriber"]}" onchange="updateValue(${i}, 'Re-subscriber', this.value)"></td>

            <td><input type="number" value="${row["New Onboarding"]}" onchange="updateValue(${i}, 'New Onboarding', this.value)"></td>

            <td>${(+row["Re-subscriber"]) + (+row["New Onboarding"])}</td>

            <td><input type="number" value="${row['Opening Balance']}" onchange="updateValue(${i}, 'Opening Balance', this.value)"></td>

            <td><input type="number" value="${row['Today Received']}" onchange="updateValue(${i}, 'Today Received', this.value)"></td>

            <td><input type="number" value="${row['Today Deposit']}" onchange="updateValue(${i}, 'Today Deposit', this.value)"></td>

            <td>${(+row["Opening Balance"]) + (+row["Today Received"]) - (+row["Today Deposit"])}</td>
        `;
        tbody.appendChild(tr);
    });
}

// ----------------------------
// UPDATE VALUE IN ROW
// ----------------------------
function updateValue(index, field, value) {
    tableData[index][field] = value;
    modifiedRows.add(index);
    renderTable();
}

// ----------------------------
// STATUS MESSAGE
// ----------------------------
function showStatus(msg, color) {
    let box = document.getElementById("apiStatus");
    box.style.display = "block";
    box.style.background = color;
    box.style.color = "white";
    box.innerHTML = msg;
}

// Auto-load
loadFromAPI();

</script>

</body>
</html>
